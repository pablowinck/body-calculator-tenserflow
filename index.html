<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Body Calculator with Tenser Flow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
      rel="stylesheet"
    />
<link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <h2>Loja Daora</h2>
    <div class="lista"></div>
    <div class="provador invisible" id="provador">
      <div class="video-container">
        <video
          id="video"
          width="720"
          height="540"
          autoplay
          class="invisible"
        ></video>
        <canvas id="canvas" width="720" height="540"></canvas>
      </div>
      <input
        type="number"
        id="personHeightCm"
        placeholder="Insira sua altura em cm"
      />
      <button onclick="handleStartStop()" id="action-button">
        Iniciar Medições
      </button>
      <div class="go-back-alert invisible">
        <p>Vá para trás e se posicione no centro.</p>
      </div>
      <p id="best-score">
        <strong>Seu tamanho ideal:</strong> <span id="best-score-value"></span>
      </p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <!-- commons -->
    <script>
      const accuracyGoal = 0.8;
      let personHeightCm; // Global variable to store the person's height
      let sizes; // Variable to store the sizes
    </script>
    <!-- calculador de corpo -->
    <script>
      /**
       * Function to calculate measurements
       * @param {number} personHeight Height of the person in cm
       * @param {object} image Image element
       * @param {object} net PoseNet model
       * @returns Measurements and PoseNet score
       */
      async function calculateMeasurements(personHeight, image, net) {
        // This validation is just if you want to use the function directly
        if (isNaN(personHeight) || personHeight <= 0) {
          alert("Por favor, insira uma altura válida em cm.");
          return;
        }
        return loadAndUsePoseNet(image, net).then((pose) => {
          const measurements = calculateBodyMeasurements(
            pose.keypoints,
            personHeight,
            image.height
          );
          return { measurements, score: pose.score };
        });
      }

      /**
       * Function to load and use PoseNet
       * @param {object} image Image element
       * @returns PoseNet keypoints
       */
      async function loadAndUsePoseNet(image) {
        const net = await posenet.load();
        const pose = await net.estimateSinglePose(image, {
          flipHorizontal: false,
        });
        return pose;
      }

      /**
       * Function to calculate body measurements
       * @param {array} poseKeypoints PoseNet keypoints
       * @param {number} personHeightCm Height of the person in cm
       * @param {number} videoHeightPixels Height of the video in pixels
       * @returns Body measurements
       */
      function calculateBodyMeasurements(
        poseKeypoints,
        personHeightCm,
        videoHeightPixels
      ) {
        // Calculate the scale from pixels to centimeters
        const scaleCmPerPixel = personHeightCm / videoHeightPixels;

        // Function to calculate the distance between two points
        function distanceBetweenPoints(point1, point2) {
          return Math.sqrt(
            Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2)
          );
        }

        // Find keypoints
        const leftShoulder = poseKeypoints.find(
          (point) => point.part === "leftShoulder"
        ).position;
        const rightShoulder = poseKeypoints.find(
          (point) => point.part === "rightShoulder"
        ).position;
        const leftHip = poseKeypoints.find(
          (point) => point.part === "leftHip"
        ).position;
        const rightHip = poseKeypoints.find(
          (point) => point.part === "rightHip"
        ).position;

        // Calculate distances in pixels
        const shoulderDistancePixels = distanceBetweenPoints(
          leftShoulder,
          rightShoulder
        );
        const hipDistancePixels = distanceBetweenPoints(leftHip, rightHip);

        // This calc needs to be improved, but it's a start
        const waistEstimatePixels =
          hipDistancePixels * 2 + hipDistancePixels * 0.4;

        // Convert measurements from pixels to centimeters using the scale
        const shoulderDistanceCm = shoulderDistancePixels * scaleCmPerPixel;
        const waistEstimateCm = waistEstimatePixels * scaleCmPerPixel;
        const hipDistanceCm = hipDistancePixels * scaleCmPerPixel;

        return {
          shoulders: shoulderDistanceCm.toFixed(2),
          waist: waistEstimateCm.toFixed(2),
          hips: hipDistanceCm.toFixed(2),
        };
      }
    </script>
    <!-- preenchedor de roupas -->
    <script>
      const camisetNike = {
        nome: "Camiseta Nike",
        imagem:
          "https://images.tcdn.com.br/img/img_prod/1034143/camiseta_nike_masculina_sportswear_ar4993_2181_1_e493bc1bb066486bcbd03a28b9dafe3d.jpg",
        tamanhos: [
          {
            tamanho: "P",
            medidas: {
              ombro: 55,
              cintura: 85,
              quadril: 95,
            },
          },
          {
            tamanho: "M",
            medidas: {
              ombro: 70,
              cintura: 95,
              quadril: 100,
            },
          },
          {
            tamanho: "G",
            medidas: {
              ombro: 80,
              cintura: 100,
              quadril: 105,
            },
          },
        ],
      };
      const camisetaAdidas = {
        nome: "Camiseta Adidas",
        imagem:
          "https://www.botoli.com.br/cdn/imagens/produtos/det/camiseta-adidas-m-fr-lg-t-masculino-989d548d173548d6c1db9ac98f97763b.jpg",
        tamanhos: [
          {
            tamanho: "P",
            medidas: {
              ombro: 53,
              cintura: 78,
              quadril: 91,
            },
          },
          {
            tamanho: "M",
            medidas: {
              ombro: 65,
              cintura: 85,
              quadril: 95,
            },
          },
          {
            tamanho: "G",
            medidas: {
              ombro: 85,
              cintura: 90,
              quadril: 100,
            },
          },
        ],
      };
      const roupas = [...Array(10).keys()].map((_, i) => {
        return i % 2 === 0 ? camisetNike : camisetaAdidas;
      });
      const lista = document.querySelector(".lista");
      roupas.forEach((roupa) => {
        const div = document.createElement("div");
        div.innerHTML = `
        <div class="roupa">
                <h3>${roupa.nome}</h3>
                <img src="${roupa.imagem}" alt="${roupa.nome}" />
                <div class="medidas">
                        <select>
                                ${roupa.tamanhos
                                  .map(
                                    (tamanho) =>
                                      `<option value="${JSON.stringify(
                                        tamanho.medidas
                                      )}">${tamanho.tamanho}</option>`
                                  )
                                  .join("")}
                        </select>
                        <button class="provar-button" data-tamanhos='${JSON.stringify(
                          roupa.tamanhos
                        )}'>Provar</button>
                </div>
                <button>Comprar</button>
        </div>
            `;
        div.querySelector(".provar-button").addEventListener("click", (e) => {
          console.log(e.target.dataset);
          const tamanhos = JSON.parse(e.target.dataset.tamanhos);
          mostrarProvador(tamanhos);
        });
        lista.appendChild(div);
      });
    </script>
    <!-- provador -->
    <script>
      let net; // Variable to store the PoseNet model
      let started = false; // Variable to store whether the measurements have started
      let videoVisible = false; // Variable to store whether the video is visible
      let moreThan80Scores = [];

      function mostrarProvador(tamanhos) {
        if (started) {
          stopMeasurements();
          document.getElementById("action-button").innerText =
            "Iniciar Medições";
        }
        document.getElementById("provador").classList.remove("invisible");
        document.getElementById("action-button").innerText = "Iniciar Medições";
        document.getElementById("best-score-value").innerText = "";
        document.getElementById("personHeightCm").value = "";
        document.querySelector(".provador").classList.remove("invisible");
        sizes = tamanhos;
      }

      async function handleStartStop() {
        if (started) {
          stopMeasurements();
          document.getElementById("action-button").innerText =
            "Iniciar Medições";
        } else {
          startMeasurements();
          document.getElementById("action-button").innerText = "Parar Medições";
        }
      }

      // Start the measurements when the button is clicked
      async function startMeasurements() {
        personHeightCm = parseFloat(
          document.getElementById("personHeightCm").value
        );
        if (isNaN(personHeightCm) || personHeightCm <= 0) {
          alert("Por favor, insira uma altura válida em cm.");
          return;
        }
        // Load the PoseNet model
        net = await posenet.load();
        // Start the webcam
        await setupCamera();
        // Start the measurement loop
        started = true;
        measureLoop();
      }

      function stopMeasurements() {
        started = false;
        document.querySelector(".go-back-alert").classList.add("invisible");
      }

      async function setupCamera() {
        const video = document.getElementById("video");
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        video.srcObject = stream;
        document.getElementById("video").classList.remove("invisible");
        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            resolve(video);
          };
        });
      }

      // The measurement loop
      async function measureLoop() {
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        async function poseDetectionFrame() {
          if (!started) {
            return;
          }
          const pose = await net.estimateSinglePose(video, {
            flipHorizontal: false,
          });
          if (pose.score < accuracyGoal) {
            document.getElementById("canvas").classList.add("invisible");
            document.getElementById("video").classList.remove("invisible");
            document
              .querySelector(".go-back-alert")
              .classList.remove("invisible");
            setTimeout(poseDetectionFrame, 100);
            return;
          }

          document.querySelector(".go-back-alert").classList.add("invisible");
          document.getElementById("video").classList.add("invisible");
          document.getElementById("canvas").classList.remove("invisible");
          drawCanvas(pose, video, canvas, ctx);
          const measurements = calculateBodyMeasurements(
            pose.keypoints,
            personHeightCm,
            video.videoHeight
          );
          if (pose.score > accuracyGoal) {
            moreThan80Scores.push(measurements);
            let average = moreThan80Scores.reduce(
              (acc, curr) => {
                return {
                  shoulders: +acc.shoulders + +curr.shoulders,
                  waist: +acc.waist + +curr.waist,
                  hips: +acc.hips + +curr.hips,
                };
              },
              { shoulders: 0, waist: 0, hips: 0 }
            );
            average.shoulders = (
              average.shoulders / moreThan80Scores.length
            ).toFixed(2);
            average.waist = (average.waist / moreThan80Scores.length).toFixed(
              2
            );
            average.hips = (average.hips / moreThan80Scores.length).toFixed(2);
            const tamanhosQueServem = sizes.filter((tamanho) => {
              const margemErro = 2;
              const isOmbroMenorOuIgual =
                average.shoulders <= tamanho.medidas.ombro + margemErro;
              const isCinturaMenorOuIgual =
                average.waist <= tamanho.medidas.cintura + margemErro;
              const isQuadrilMenorOuIgual =
                average.hips <= tamanho.medidas.quadril + margemErro;
              return (
                isOmbroMenorOuIgual &&
                isCinturaMenorOuIgual &&
                isQuadrilMenorOuIgual
              );
            });
            const melhorTamanho = tamanhosQueServem.reduce((acc, curr) => {
              const accDist = Math.abs(
                acc.medidas.ombro +
                  acc.medidas.cintura +
                  acc.medidas.quadril -
                  (average.shoulders + average.waist + average.hips)
              );
              const currDist = Math.abs(
                curr.medidas.ombro +
                  curr.medidas.cintura +
                  curr.medidas.quadril -
                  (average.shoulders + average.waist + average.hips)
              );
              return accDist < currDist ? acc : curr;
            }, tamanhosQueServem[0]);
            console.log({ tamanhosQueServem });
            console.log({ melhorTamanho });
            if (tamanhosQueServem.length > 0) {
              let result = melhorTamanho.tamanho;
              if (tamanhosQueServem.length > 1) {
                result +=
                  " (melhor) ou " +
                  tamanhosQueServem
                    .filter(({ tamanho }) => tamanho !== melhorTamanho.tamanho)
                    .map(({ tamanho }) => tamanho);
              }
              document.getElementById("best-score-value").innerText = result;
            } else {
              document.getElementById("best-score-value").innerText =
                "Não foi possível encontrar um tamanho";
            }
          }
          setTimeout(poseDetectionFrame, 50); // Wait for 5 seconds before the next measurement
        }
        poseDetectionFrame();
      }

      // Draw the detected pose onto the canvas
      function drawCanvas(pose, video, canvas, ctx) {
        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Draw the video
        ctx.save();
        ctx.scale(-1, 1); // Mirrors the canvas
        ctx.translate(-canvas.width, 0); // Adjust for the mirrored translation
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height); // Use canvas dimensions
        ctx.restore();
        // Draw the pose
        pose.keypoints.forEach((keypoint) => {
          if (keypoint.score > accuracyGoal) {
            const { y, x } = keypoint.position;
            ctx.beginPath();
            const mirroredX = canvas.width - x; // Mirror the keypoint's x position
            ctx.arc(mirroredX, y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "aqua";
            ctx.fill();
          }
        });
      }
      window.onload = setupCamera();
    </script>
  </body>
</html>
